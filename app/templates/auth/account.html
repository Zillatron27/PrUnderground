{% extends "base.html" %}

{% block content %}
<div class="account-page">
    <h1>Account Settings</h1>

    {% if request.query_params.get('updated') %}
    <div class="alert alert-success">
        API key updated successfully.
    </div>
    {% endif %}

    {% if error %}
    <div class="alert alert-error">
        {{ error }}
    </div>
    {% endif %}

    <section class="account-section">
        <h2>FIO Connection</h2>
        <div class="info-grid">
            <div class="info-row">
                <span class="info-label">Username</span>
                <span class="info-value">{{ user.fio_username }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Company</span>
                <span class="info-value">
                    {% if user.company_code %}
                    [{{ user.company_code }}] {{ user.company_name or '' }}
                    {% else %}
                    <span class="text-dim">Not set</span>
                    {% endif %}
                </span>
            </div>
            <div class="info-row">
                <span class="info-label">API Key</span>
                <span class="info-value">
                    {% if masked_key %}
                    <code>{{ masked_key }}</code>
                    {% else %}
                    <span class="text-dim">Not set</span>
                    {% endif %}
                </span>
            </div>
            <div class="info-row">
                <span class="info-label">Member Since</span>
                <span class="info-value">{{ user.created_at.strftime('%d %B %Y') }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Last Updated</span>
                <span class="info-value">{{ user.updated_at.strftime('%d %B %Y at %H:%M') }}</span>
            </div>
        </div>
    </section>

    <section class="account-section">
        <h2>Update API Key</h2>
        <p class="section-description">
            If your API key has expired or you need to use a new one, enter it below.
            FIO API keys don't expire automatically, but you may need to regenerate one
            if you've revoked it or changed your FIO password.
        </p>

        <form action="/auth/refresh-key" method="post" class="account-form">
            <input type="hidden" name="{{ csrf_field_name }}" value="{{ csrf_token }}">
            <div class="form-group">
                <label for="fio_api_key">New API Key</label>
                <input type="password" id="fio_api_key" name="fio_api_key" required
                       placeholder="Paste your new API key">
            </div>
            <button type="submit" class="btn btn-primary">Update Key</button>
        </form>

        <p class="help-text">
            Need a new key? Go to <a href="https://fio.fnar.net/settings" target="_blank">FIO Settings</a>
            and create one under "API Keys".
        </p>
    </section>

    <section class="account-section">
        <h2>Import / Export</h2>
        <div class="data-management-grid">
            <div class="data-card">
                <h3>Export</h3>
                <p>Download your data as a JSON file.</p>
                <div class="data-actions">
                    <a href="/data/export/backup" class="btn btn-secondary" download>Export Data</a>
                </div>
            </div>
            <div class="data-card">
                <h3>Import</h3>
                <p>Restore data from a JSON backup file.</p>
                <form id="import-form" enctype="multipart/form-data">
                    <input type="hidden" name="{{ csrf_field_name }}" value="{{ csrf_token }}">
                    <div class="form-group">
                        <label for="import-file">Select file</label>
                        <input type="file" id="import-file" name="file" accept=".json" required>
                    </div>
                    <div class="form-group">
                        <label for="import-mode">Import mode</label>
                        <select id="import-mode" name="mode">
                            <option value="merge_update">Merge (update existing + add new)</option>
                            <option value="merge_add">Merge (add new only)</option>
                            <option value="replace">Replace all</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Import</button>
                </form>
                <div id="import-result" class="import-result"></div>
            </div>
        </div>
    </section>

    <section class="account-section">
        <h2>Data Storage</h2>
        <p class="section-description">
            PrUnderground stores the following information:
        </p>
        <ul class="data-list">
            <li><strong>FIO Username</strong> - To identify your account</li>
            <li><strong>FIO API Key</strong> - To fetch your production and inventory data</li>
            <li><strong>Company Info</strong> - Your company code and name from FIO</li>
            <li><strong>Listings</strong> - The listings you create on PrUnderground</li>
        </ul>
        <p class="section-description">
            We only fetch data from FIO when you use features that need it (dashboard, creating listings).
            Your API key is stored securely and never shared.
        </p>
    </section>

    <div class="account-actions">
        <a href="/auth/logout" class="btn btn-danger">Log Out</a>
    </div>
</div>

<script>
document.getElementById('import-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const resultDiv = document.getElementById('import-result');
    const submitBtn = form.querySelector('button[type="submit"]');

    submitBtn.disabled = true;
    submitBtn.textContent = 'Importing...';
    resultDiv.innerHTML = '';
    resultDiv.className = 'import-result';

    const formData = new FormData(form);

    try {
        const response = await fetch('/data/import', {
            method: 'POST',
            body: formData,
        });

        const result = await response.json();

        if (response.ok) {
            resultDiv.className = 'import-result success';
            resultDiv.innerHTML = `Import successful: ${result.added} added, ${result.updated} updated, ${result.skipped} skipped` +
                (result.deleted > 0 ? `, ${result.deleted} deleted` : '');
        } else {
            resultDiv.className = 'import-result error';
            resultDiv.innerHTML = `Import failed: ${result.detail || 'Unknown error'}`;
        }
    } catch (err) {
        resultDiv.className = 'import-result error';
        resultDiv.innerHTML = `Import failed: ${err.message}`;
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Import';
    }
});
</script>
{% endblock %}
