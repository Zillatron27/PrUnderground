{% extends "base.html" %}

{% block content %}
<div class="form-page">
    <h1>{% if bundle %}Edit{% else %}Create{% endif %} Bundle</h1>

    <form method="post" action="{% if bundle %}/bundles/{{ bundle.id }}/edit{% else %}/bundles/new{% endif %}" class="listing-form" onsubmit="return validateBundleForm()" autocomplete="off">
        <input type="hidden" name="{{ csrf_field_name }}" value="{{ csrf_token }}">

        <div class="form-group">
            <label for="name">Bundle Name <span class="required">*</span></label>
            <input type="text" id="name" name="name"
                   value="{{ bundle.name if bundle else '' }}"
                   required maxlength="100" placeholder="e.g., 5k5k HCB Ship Kit">
        </div>

        <div class="form-group">
            <label for="description">Description (optional)</label>
            <textarea id="description" name="description" rows="2"
                      placeholder="Specs, details, etc.">{{ bundle.description if bundle else '' }}</textarea>
        </div>

        <div class="form-group">
            <label>Bundle Items <span class="required">*</span></label>
            <p class="help-text">Add materials included in this bundle (at least one required)</p>
            <p class="help-text error-text" id="items-error" style="display: none;">Please add at least one item to the bundle</p>
        </div>

        <div class="bundle-items-wrapper">
            <div id="bundle-items-container">
                {% if bundle and bundle.items %}
                    {% for item in bundle.items %}
                    <div class="bundle-item-row" data-index="{{ loop.index0 }}">
                        <div class="form-row">
                            <div class="form-group">
                                <input type="text" name="item_ticker_{{ loop.index0 }}"
                                       value="{{ item.material_ticker }}"
                                       required maxlength="10" placeholder="Material"
                                       list="material-list">
                            </div>
                            <div class="form-group">
                                <input type="number" name="item_qty_{{ loop.index0 }}"
                                       value="{{ item.quantity }}"
                                       min="1" required placeholder="Qty">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeItemRow(this)">Remove</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="bundle-item-row" data-index="0">
                        <div class="form-row">
                            <div class="form-group">
                                <input type="text" name="item_ticker_0"
                                       required maxlength="10" placeholder="Material"
                                       list="material-list">
                            </div>
                            <div class="form-group">
                                <input type="number" name="item_qty_0"
                                       min="1" value="1" required placeholder="Qty">
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeItemRow(this)">Remove</button>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
            <button type="button" class="btn btn-secondary" onclick="addItemRow()" id="add-item-btn">+ Add Item</button>
        </div>
        <datalist id="material-list" hx-get="/listings/api/materials" hx-trigger="load" hx-swap="innerHTML">
        </datalist>

        <hr class="form-divider">

        <div class="form-group">
            <label>Stock Mode</label>
            <div class="price-options">
                <label class="radio-option">
                    <input type="radio" name="stock_mode" value="manual"
                           {% if not bundle or bundle.stock_mode.value == 'manual' %}checked{% endif %}
                           onchange="toggleStockModeFields()">
                    <span>Manual Quantity</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="stock_mode" value="unlimited"
                           {% if bundle and bundle.stock_mode.value == 'unlimited' %}checked{% endif %}
                           onchange="toggleStockModeFields()">
                    <span>Unlimited</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="stock_mode" value="made_to_order"
                           {% if bundle and bundle.stock_mode.value == 'made_to_order' %}checked{% endif %}
                           onchange="toggleStockModeFields()">
                    <span>Made to Order</span>
                </label>
                {% if has_fio_key %}
                <label class="radio-option">
                    <input type="radio" name="stock_mode" value="fio_sync"
                           {% if bundle and bundle.stock_mode.value == 'fio_sync' %}checked{% endif %}
                           onchange="toggleStockModeFields()">
                    <span>FIO Sync</span>
                </label>
                {% endif %}
            </div>
        </div>

        <div class="form-row" id="manual-qty-fields">
            <div class="form-group">
                <label for="quantity">Quantity Available <span class="required">*</span></label>
                <input type="number" id="quantity" name="quantity" min="0"
                       value="{{ bundle.quantity if bundle and bundle.quantity else '' }}"
                       placeholder="e.g., 10">
            </div>
            <div class="form-group">
                <label for="low_stock_threshold">Low Stock Threshold</label>
                <input type="number" id="low_stock_threshold" name="low_stock_threshold" min="0"
                       value="{{ bundle.low_stock_threshold if bundle and bundle.low_stock_threshold is not none else '' }}"
                       placeholder="Leave blank for no threshold">
                <p class="help-text">Optional - show "Low Stock" badge at or below this quantity</p>
            </div>
        </div>

        <div class="form-row" id="made-to-order-fields" style="display: none;">
            <div class="form-group">
                <label for="ready_quantity">Ready Quantity (optional)</label>
                <input type="number" id="ready_quantity" name="ready_quantity" min="0"
                       value="{{ bundle.ready_quantity if bundle and bundle.ready_quantity else '' }}"
                       placeholder="How many ready now?">
                <p class="help-text" style="margin-top: var(--space-sm);">Leave blank if none ready yet</p>
            </div>
        </div>

        <div class="form-group fio-data-container" id="fio-sync-fields" style="display: none;">
            <div class="fio-data-overlay fio-data-overlay-inline">
                <div class="spinner-data spinner-sm"></div>
                <span>Loading storages...</span>
            </div>
            <label for="storage_id">Inventory</label>
            <select id="storage_id" name="storage_id" onchange="updateStorageName(); updateInventoryPreview();">
                <option value="">Select storage...</option>
            </select>
            <input type="hidden" id="storage_name" name="storage_name" value="{{ bundle.storage_name if bundle else '' }}">
            <p class="help-text" style="margin-top: var(--space-sm);">Bundle quantity will be computed from FIO inventory</p>
            <div id="fio-inventory-preview"></div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="location">Pickup Location</label>
                <input type="text" id="location" name="location" maxlength="50"
                       value="{{ bundle.location if bundle else '' }}"
                       placeholder="e.g., Moria Station"
                       list="location-list">
                <datalist id="location-list" hx-get="/bundles/api/locations" hx-trigger="load" hx-swap="innerHTML">
                </datalist>
                <p class="help-text price-preview">Start typing to search</p>
            </div>
        </div>

        <div class="form-group">
            <label>Pricing</label>
            <div class="price-options">
                <label class="radio-option">
                    <input type="radio" name="price_mode" value="fixed"
                           {% if not bundle or bundle.price %}checked{% endif %}
                           onchange="toggleBundlePriceFields()">
                    <span>Fixed Price</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="price_mode" value="contact"
                           {% if bundle and not bundle.price %}checked{% endif %}
                           onchange="toggleBundlePriceFields()">
                    <span>Contact Me</span>
                </label>
            </div>
        </div>

        <div class="form-row" id="bundle-price-fields">
            <div class="form-group">
                <label for="price">Total Bundle Price</label>
                <input type="number" id="price" name="price" step="0.01" min="0"
                       value="{{ bundle.price if bundle and bundle.price else '' }}"
                       placeholder="e.g., 11000000"
                       oninput="updatePricePreview()">
                <p class="help-text price-preview" id="price-preview"></p>
            </div>
            <div class="form-group">
                <label for="currency">Currency</label>
                <select id="currency" name="currency" onchange="updatePricePreview()">
                    {% for curr in currencies %}
                    <option value="{{ curr }}" {% if bundle and bundle.currency == curr %}selected{% endif %}>
                        {{ curr }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <input type="hidden" name="contact_me" id="contact_me" value="">

        <div class="form-row">
            <div class="form-group">
                <label for="listing_type">Listing Type</label>
                <select id="listing_type" name="listing_type" onchange="toggleExpiryField()">
                    <option value="standing" {% if not bundle or bundle.listing_type.value == 'standing' %}selected{% endif %}>
                        Standing Offer
                    </option>
                    <option value="special" {% if bundle and bundle.listing_type.value == 'special' %}selected{% endif %}>
                        Special/Deal
                    </option>
                </select>
            </div>
            <div class="form-group" id="expiry-field" style="display:none">
                <label for="expires_at">Expires (optional)</label>
                <input type="date" id="expires_at" name="expires_at"
                       value="{{ bundle.expires_at.strftime('%Y-%m-%d') if bundle and bundle.expires_at else '' }}">
                <p class="help-text">Leave empty for no expiry</p>
            </div>
        </div>

        <div class="form-group">
            <label for="notes">Notes (optional)</label>
            <textarea id="notes" name="notes" rows="3"
                      placeholder="Any additional info (bulk discounts, availability, etc.)">{{ bundle.notes if bundle else '' }}</textarea>
        </div>

        <div class="form-actions">
            <div class="form-actions-primary">
                <button type="submit" class="btn btn-primary">
                    {% if bundle %}Update{% else %}Create{% endif %} Bundle
                </button>
                <a href="/dashboard" class="btn btn-secondary">Cancel</a>
            </div>
            {% if bundle %}
            <div class="form-actions-danger">
                <button type="button" class="btn btn-danger" onclick="deleteBundle()">Delete</button>
            </div>
            {% endif %}
        </div>
    </form>

    {% if bundle %}
    <form id="delete-form" method="post" action="/bundles/{{ bundle.id }}/delete" style="display: none;">
        <input type="hidden" name="{{ csrf_field_name }}" value="{{ csrf_token }}">
    </form>
    {% endif %}
</div>

<script>
let itemIndex = {{ bundle.items|length if bundle and bundle.items else 1 }};

function addItemRow() {
    const container = document.getElementById('bundle-items-container');
    const row = document.createElement('div');
    row.className = 'bundle-item-row';
    row.dataset.index = itemIndex;
    row.innerHTML = `
        <div class="form-row">
            <div class="form-group">
                <input type="text" name="item_ticker_${itemIndex}"
                       required maxlength="10" placeholder="Material"
                       list="material-list">
            </div>
            <div class="form-group">
                <input type="number" name="item_qty_${itemIndex}"
                       min="1" value="1" required placeholder="Qty">
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-sm btn-danger" onclick="removeItemRow(this)">Remove</button>
            </div>
        </div>
    `;
    container.appendChild(row);
    itemIndex++;
    updateInventoryPreview();
}

function removeItemRow(btn) {
    btn.closest('.bundle-item-row').remove();
    updateInventoryPreview();
}

function toggleBundlePriceFields() {
    const priceMode = document.querySelector('input[name="price_mode"]:checked').value;
    const priceFields = document.getElementById('bundle-price-fields');
    const contactMe = document.getElementById('contact_me');

    if (priceMode === 'contact') {
        priceFields.style.display = 'none';
        contactMe.value = '1';
    } else {
        priceFields.style.display = 'flex';
        contactMe.value = '';
    }
}

function updatePricePreview() {
    const priceInput = document.getElementById('price');
    const currencySelect = document.getElementById('currency');
    const preview = document.getElementById('price-preview');

    const value = parseFloat(priceInput.value);
    if (isNaN(value) || value === 0) {
        preview.textContent = '';
        return;
    }

    const currency = currencySelect.value || '';
    const formatted = value.toLocaleString(undefined, {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    });
    preview.textContent = `${formatted} ${currency}`;
}

function toggleExpiryField() {
    const listingType = document.getElementById('listing_type').value;
    document.getElementById('expiry-field').style.display =
        listingType === 'special' ? 'block' : 'none';
}

function validateBundleForm() {
    const container = document.getElementById('bundle-items-container');
    const itemRows = container.querySelectorAll('.bundle-item-row');
    const errorEl = document.getElementById('items-error');

    // Check if there's at least one item with a ticker
    let hasValidItem = false;
    for (const row of itemRows) {
        const tickerInput = row.querySelector('input[name^="item_ticker_"]');
        if (tickerInput && tickerInput.value.trim()) {
            hasValidItem = true;
            break;
        }
    }

    if (!hasValidItem) {
        errorEl.style.display = 'block';
        container.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
    }

    errorEl.style.display = 'none';

    // Validate quantity for manual mode
    const stockMode = document.querySelector('input[name="stock_mode"]:checked').value;
    if (stockMode === 'manual') {
        const quantityInput = document.getElementById('quantity');
        if (!quantityInput.value || quantityInput.value.trim() === '') {
            quantityInput.focus();
            return false;
        }
    }

    return true;
}

function deleteBundle() {
    if (confirm('Are you sure you want to delete this bundle? This cannot be undone.')) {
        document.getElementById('delete-form').submit();
    }
}

function toggleStockModeFields() {
    // Preserve current items before any DOM changes
    const itemsContainer = document.getElementById('bundle-items-container');
    const currentItems = itemsContainer.innerHTML;

    const stockMode = document.querySelector('input[name="stock_mode"]:checked').value;
    const manualFields = document.getElementById('manual-qty-fields');
    const madeToOrderFields = document.getElementById('made-to-order-fields');
    const fioSyncFields = document.getElementById('fio-sync-fields');
    const quantityInput = document.getElementById('quantity');

    // Hide all conditional fields
    manualFields.style.display = 'none';
    madeToOrderFields.style.display = 'none';
    fioSyncFields.style.display = 'none';

    // Show the relevant fields and set required attribute
    if (stockMode === 'manual') {
        manualFields.style.display = 'flex';
        quantityInput.required = true;
    } else {
        quantityInput.required = false;
    }

    if (stockMode === 'made_to_order') {
        madeToOrderFields.style.display = 'flex';
    } else if (stockMode === 'fio_sync') {
        fioSyncFields.style.display = 'block';
        loadBundleStorages();
    }

    // Restore items if they were cleared (browser autofill interference)
    if (!itemsContainer.children.length) {
        itemsContainer.innerHTML = currentItems;
    }
}

let storagesLoaded = false;
function loadBundleStorages() {
    if (storagesLoaded) return;
    storagesLoaded = true;

    const container = document.getElementById('fio-sync-fields');
    const select = document.getElementById('storage_id');
    const selectedId = '{{ bundle.storage_id if bundle else "" }}';

    // Show loading spinner
    container.classList.add('loading');

    fetch('/bundles/api/storages' + (selectedId ? '?selected=' + encodeURIComponent(selectedId) : ''))
        .then(response => response.text())
        .then(html => {
            select.innerHTML = html;
            // Trigger inventory preview if editing existing bundle with storage
            if (selectedId && select.value) {
                updateInventoryPreview();
            }
        })
        .catch(err => {
            console.error('Failed to load storages:', err);
        })
        .finally(() => {
            container.classList.remove('loading');
        });
}

function updateStorageName() {
    const select = document.getElementById('storage_id');
    const nameInput = document.getElementById('storage_name');
    const selectedOption = select.options[select.selectedIndex];

    if (selectedOption && selectedOption.dataset.name) {
        nameInput.value = selectedOption.dataset.name;
    } else {
        nameInput.value = '';
    }
}

// FIO Inventory Preview
let inventoryPreviewTimeout = null;

function updateInventoryPreview() {
    // Clear any pending timeout
    if (inventoryPreviewTimeout) {
        clearTimeout(inventoryPreviewTimeout);
    }

    // Debounce the preview update
    inventoryPreviewTimeout = setTimeout(doUpdateInventoryPreview, 500);
}

function doUpdateInventoryPreview() {
    const stockMode = document.querySelector('input[name="stock_mode"]:checked').value;
    const previewDiv = document.getElementById('fio-inventory-preview');

    // Only update if FIO Sync mode is active
    if (stockMode !== 'fio_sync') {
        if (previewDiv) previewDiv.innerHTML = '';
        return;
    }

    const storageId = document.getElementById('storage_id').value;
    if (!storageId) {
        previewDiv.innerHTML = '';
        return;
    }

    // Collect items from the form
    const items = [];
    const container = document.getElementById('bundle-items-container');
    const itemRows = container.querySelectorAll('.bundle-item-row');

    itemRows.forEach(row => {
        const tickerInput = row.querySelector('input[name^="item_ticker_"]');
        const qtyInput = row.querySelector('input[name^="item_qty_"]');

        if (tickerInput && qtyInput && tickerInput.value.trim()) {
            items.push({
                ticker: tickerInput.value.trim().toUpperCase(),
                qty: parseInt(qtyInput.value) || 1
            });
        }
    });

    if (items.length === 0) {
        previewDiv.innerHTML = '';
        return;
    }

    // Build query string
    const params = new URLSearchParams();
    params.append('storage_id', storageId);
    params.append('items', JSON.stringify(items));

    // Show loading state
    previewDiv.innerHTML = '<div class="fio-loading"><div class="spinner-data spinner-sm"></div><span class="fio-loading-text">Loading FIO data...</span></div>';

    // Fetch preview
    fetch('/bundles/api/inventory-preview?' + params.toString())
        .then(response => response.text())
        .then(html => {
            previewDiv.innerHTML = html;
        })
        .catch(err => {
            console.error('Failed to load inventory preview:', err);
            previewDiv.innerHTML = '<p class="help-text error-text">Failed to load inventory</p>';
        });
}

function setupInventoryPreviewListeners() {
    // Use event delegation for item inputs
    const container = document.getElementById('bundle-items-container');
    container.addEventListener('input', function(e) {
        if (e.target.matches('input[name^="item_ticker_"], input[name^="item_qty_"]')) {
            updateInventoryPreview();
        }
    });
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    toggleBundlePriceFields();
    toggleExpiryField();
    updatePricePreview();
    toggleStockModeFields();
    setupInventoryPreviewListeners();
});
</script>
{% endblock %}
