{% extends "base.html" %}
{% from "macros/responsive.html" import material_ticker, quantity_display, status_badge, status_dot, price_display, cx_location, bundle_price_display, bundle_quantity_display, bundle_status_badge, bundle_status_dot, date_display %}

{% block content %}
<div class="dashboard">
    <header class="dashboard-header">
        <div>
            <h1>Welcome, {{ current_user.fio_username }}</h1>
            <p class="company-info">
                {% if current_user.company_code %}
                    [{{ current_user.company_code }}] {{ current_user.company_name or '' }}
                {% endif %}
            </p>
        </div>
        <div class="dashboard-actions">
            <button class="btn btn-secondary" id="refresh-fio-btn"
                    hx-post="/api/fio/refresh"
                    hx-target="#fio-status"
                    hx-swap="innerHTML">
                <span class="btn-spinner htmx-indicator">
                    <span class="spinner-data spinner-sm"></span>
                </span>
                Refresh FIO Data
            </button>
            <a href="/listings/new" class="btn btn-primary">+ New Listing</a>
            <a href="/bundles/new" class="btn btn-primary">+ New Bundle</a>
        </div>
    </header>

    <div class="fio-status-bar" id="fio-status"
         hx-get="/api/dashboard/status" hx-trigger="fioLoaded from:body" hx-swap="innerHTML">
        {% if current_user.fio_last_synced %}
        <span class="fio-refresh-status">FIO data: {{ get_sync_staleness(current_user) }}</span>
        {% else %}
        <span class="fio-refresh-status fio-loading-inline">
            <span class="spinner-data spinner-sm"></span>
            Syncing FIO data...
        </span>
        {% endif %}
        {% if cx_sync_age %}
         · <span class="fio-refresh-status">CX prices: {{ cx_sync_age }}</span>
        {% endif %}
    </div>

    <section class="my-listings">
        <h2>Your Listings</h2>

        {% if listings %}
        <div class="fio-data-container" id="inventory-container">
            <div class="fio-data-overlay">
                <div class="spinner-data"></div>
                <span>Refreshing from FIO...</span>
            </div>
            <div class="table-wrapper">
            <table class="listings-table">
                <thead>
                    <tr>
                        <th class="col-material"><span class="hide-medium">Material</span><span class="show-medium">Mat</span></th>
                        <th class="col-status">Status</th>
                        <th class="col-quantity">Qty</th>
                        <th class="col-price">Price</th>
                        <th class="col-location"><span class="hide-medium">Location</span><span class="show-medium">Loc</span></th>
                        <th class="col-type">Type</th>
                        <th class="col-notes">Notes</th>
                        <th class="col-updated">Updated</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                </thead>
                <tbody id="inventory-tbody" hx-get="/api/dashboard/inventory" hx-trigger="load, fioRefresh from:body" hx-swap="innerHTML">
                    {% for listing in listings %}
                    {% set is_expired = listing.expires_at and listing.expires_at < now %}
                    <tr class="{% if is_expired %}listing-expired{% endif %}">
                        <td class="col-material">{{ material_ticker(listing.material_ticker, material_categories.get(listing.material_ticker)) }}</td>
                        <td class="col-status">
                            <span class="status-wide">{{ status_badge(listing) }}</span>
                            <span class="status-medium">{{ status_dot(listing) }}</span>
                        </td>
                        <td class="col-quantity qty-cell">{{ quantity_display(listing) }}</td>
                        <td class="col-price">{{ price_display(listing, cx_prices) }}</td>
                        <td class="col-location">{{ cx_location(listing.storage_name or listing.location) }}</td>
                        <td class="col-type">
                            <span class="badge badge-{{ listing.listing_type.value }}">
                                {{ listing.listing_type.value }}
                            </span>
                            {% if listing.expires_at %}
                                {% if is_expired %}
                                <span class="badge badge-expired">Expired</span>
                                {% else %}
                                <span class="expiry-info hide-medium">
                                    expires {{ listing.expires_at.strftime('%d %b') }}
                                </span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td class="col-notes notes-cell" {% if listing.notes %}title="{{ listing.notes }}"{% endif %}>
                            {{ listing.notes or '—' }}
                        </td>
                        <td class="col-updated">{{ date_display(listing.updated_at) }}</td>
                        <td class="col-actions actions">
                            <a href="/listings/{{ listing.id }}/edit" class="btn btn-sm btn-edit">Edit</a>
                            <form action="/listings/{{ listing.id }}/delete" method="post" style="display:inline">
                                <input type="hidden" name="{{ csrf_field_name }}" value="{{ csrf_token }}">
                                <button type="submit" class="btn btn-sm btn-danger"
                                        onclick="return confirm('Delete this listing?')">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <p>You don't have any listings yet.</p>
            <a href="/listings/new" class="btn btn-primary">Create your first listing</a>
        </div>
        {% endif %}
    </section>

    <section class="my-bundles">
        <h2>Your Bundles</h2>

        {% if bundles %}
        <div class="table-wrapper">
        <table class="listings-table">
            <thead>
                <tr>
                    <th class="col-name">Name</th>
                    <th class="col-status">Status</th>
                    <th class="col-items">Items</th>
                    <th class="col-quantity">Qty</th>
                    <th class="col-price">Price</th>
                    <th class="col-location"><span class="hide-medium">Location</span><span class="show-medium">Loc</span></th>
                    <th class="col-type">Type</th>
                    <th class="col-updated">Updated</th>
                    <th class="col-actions">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for bundle in bundles %}
                {% set is_expired = bundle.expires_at and bundle.expires_at < now %}
                <tr class="{% if is_expired %}listing-expired{% endif %}">
                    <td class="col-name" title="{{ bundle.name }}"><strong>{{ bundle.name }}</strong></td>
                    <td class="col-status">
                        <span class="status-wide">{{ bundle_status_badge(bundle) }}</span>
                        <span class="status-medium">{{ bundle_status_dot(bundle) }}</span>
                    </td>
                    <td class="col-items">{{ bundle.items|length }}</td>
                    <td class="col-quantity">{{ bundle_quantity_display(bundle) }}</td>
                    <td class="col-price">{{ bundle_price_display(bundle) }}</td>
                    <td class="col-location">{{ cx_location(bundle.location) }}</td>
                    <td class="col-type">
                        <span class="badge badge-{{ bundle.listing_type.value }}">
                            {{ bundle.listing_type.value }}
                        </span>
                        {% if bundle.expires_at %}
                            {% if is_expired %}
                            <span class="badge badge-expired">Expired</span>
                            {% else %}
                            <span class="expiry-info hide-medium">
                                expires {{ bundle.expires_at.strftime('%d %b') }}
                            </span>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td class="col-updated">{{ date_display(bundle.updated_at) }}</td>
                    <td class="col-actions actions">
                        <a href="/bundles/{{ bundle.id }}/edit" class="btn btn-sm btn-edit">Edit</a>
                        <form action="/bundles/{{ bundle.id }}/delete" method="post" style="display:inline">
                            <input type="hidden" name="{{ csrf_field_name }}" value="{{ csrf_token }}">
                            <button type="submit" class="btn btn-sm btn-danger"
                                    onclick="return confirm('Delete this bundle?')">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p>You don't have any bundles yet.</p>
            <a href="/bundles/new" class="btn btn-primary">Create your first bundle</a>
        </div>
        {% endif %}
    </section>

    <section class="suggestions">
        <h2>Quick Add from Your Production</h2>
        <div class="fio-data-container" id="suggestions-container">
            <div class="fio-data-overlay">
                <div class="spinner-data"></div>
                <span>Refreshing from FIO...</span>
            </div>
            <div id="suggestions-content" hx-get="/api/dashboard/suggestions" hx-trigger="load, fioRefresh from:body" hx-swap="innerHTML">
                {% include 'partials/fio_loading.html' %}
            </div>
        </div>
    </section>

    <section class="discord-export">
        <h2>Share to Discord</h2>
        <p>Edit if needed, then copy:</p>
        <div class="discord-preview-container">
            <textarea id="discord-preview" class="discord-preview" rows="8" placeholder="Loading..."></textarea>
        </div>
        <button class="btn btn-secondary" id="copy-discord-btn" onclick="copyDiscordFormat()">
            Copy to Clipboard
        </button>
    </section>
</div>

<script>
async function loadDiscordPreview() {
    const preview = document.getElementById('discord-preview');
    try {
        const response = await fetch('/u/{{ current_user.fio_username }}/discord');
        preview.value = await response.text();
    } catch (e) {
        preview.value = 'Error loading preview';
    }
}

async function copyDiscordFormat() {
    const preview = document.getElementById('discord-preview');
    const btn = document.getElementById('copy-discord-btn');

    await navigator.clipboard.writeText(preview.value);

    // Show copied feedback
    const originalText = btn.textContent;
    btn.textContent = 'Copied!';
    btn.classList.add('btn-success');

    setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('btn-success');
    }, 2000);
}

// Load discord preview on page load
document.addEventListener('DOMContentLoaded', loadDiscordPreview);

// Show loading overlay on FIO containers during refresh
document.body.addEventListener('htmx:beforeRequest', function(evt) {
    if (evt.detail.pathInfo.requestPath === '/api/fio/refresh') {
        document.querySelectorAll('.fio-data-container').forEach(el => {
            el.classList.add('loading');
        });
    }
});

// Trigger refresh of FIO data sections after manual refresh
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.pathInfo.requestPath === '/api/fio/refresh') {
        htmx.trigger(document.body, 'fioRefresh');
    }
    // Also hide overlay when inventory/suggestions finish loading
    const path = evt.detail.pathInfo.requestPath;
    if (path === '/api/dashboard/inventory' || path === '/api/dashboard/suggestions') {
        document.querySelectorAll('.fio-data-container').forEach(el => {
            el.classList.remove('loading');
        });
        // Update status bar and discord preview when inventory changes
        htmx.trigger(document.body, 'fioLoaded');
        loadDiscordPreview();
    }
});
</script>
{% endblock %}
