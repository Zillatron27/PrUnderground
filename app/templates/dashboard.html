{% extends "base.html" %}

{% block content %}
<div class="dashboard">
    <header class="dashboard-header">
        <div>
            <h1>Welcome, {{ current_user.fio_username }}</h1>
            <p class="company-info">
                {% if current_user.company_code %}
                    [{{ current_user.company_code }}] {{ current_user.company_name or '' }}
                {% endif %}
            </p>
        </div>
        <div class="dashboard-actions">
            <button class="btn btn-secondary" id="refresh-fio-btn"
                    hx-post="/api/fio/refresh"
                    hx-target="#fio-status"
                    hx-swap="innerHTML">
                <span class="btn-spinner htmx-indicator">
                    <span class="spinner-data spinner-sm"></span>
                </span>
                Refresh FIO Data
            </button>
            <a href="/listings/new" class="btn btn-primary">+ New Listing</a>
        </div>
    </header>

    <div class="fio-status-bar" id="fio-status">
        {% if cache_status.last_refresh %}
        <span class="fio-refresh-status">FIO data cached</span>
        {% else %}
        <span class="fio-refresh-status">FIO data not loaded</span>
        {% endif %}
    </div>

    <section class="my-listings">
        <h2>Your Listings</h2>

        {% if listings %}
        <div class="fio-data-container" id="inventory-container">
            <div class="fio-data-overlay">
                <div class="spinner-data"></div>
                <span>Refreshing from FIO...</span>
            </div>
            <div class="table-wrapper">
            <table class="listings-table">
                <thead>
                    <tr>
                        <th>Material</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Location</th>
                        <th>Type</th>
                        <th>Notes</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventory-tbody" hx-get="/api/dashboard/inventory" hx-trigger="load, fioRefresh from:body" hx-swap="innerHTML">
                    {% for listing in listings %}
                    {% set is_expired = listing.expires_at and listing.expires_at < now %}
                    <tr class="{% if is_expired %}listing-expired{% endif %}">
                        <td><strong>{{ listing.material_ticker }}</strong></td>
                        <td>
                            {% if listing.quantity %}
                                {{ listing.quantity }}
                            {% else %}
                                <span class="fio-loading-inline"><span class="spinner-data spinner-sm"></span></span>
                            {% endif %}
                        </td>
                        <td>{{ format_price(listing) }}</td>
                        <td>{{ listing.storage_name or listing.location or '—' }}</td>
                        <td>
                            <span class="badge badge-{{ listing.listing_type.value }}">
                                {{ listing.listing_type.value }}
                            </span>
                            {% if listing.expires_at %}
                                {% if is_expired %}
                                <span class="badge badge-expired">Expired</span>
                                {% else %}
                                <span class="expiry-info">
                                    expires {{ listing.expires_at.strftime('%d %b') }}
                                </span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td class="notes-cell" {% if listing.notes %}title="{{ listing.notes }}"{% endif %}>
                            {{ listing.notes or '—' }}
                        </td>
                        <td>{{ listing.updated_at.strftime('%Y-%m-%d') }}</td>
                        <td class="actions">
                            <a href="/listings/{{ listing.id }}/edit" class="btn btn-sm">Edit</a>
                            <form action="/listings/{{ listing.id }}/delete" method="post" style="display:inline">
                                <button type="submit" class="btn btn-sm btn-danger"
                                        onclick="return confirm('Delete this listing?')">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <p>You don't have any listings yet.</p>
            <a href="/listings/new" class="btn btn-primary">Create your first listing</a>
        </div>
        {% endif %}
    </section>

    <section class="suggestions">
        <h2>Quick Add from Your Production</h2>
        <div class="fio-data-container" id="suggestions-container">
            <div class="fio-data-overlay">
                <div class="spinner-data"></div>
                <span>Refreshing from FIO...</span>
            </div>
            <div id="suggestions-content" hx-get="/api/dashboard/suggestions" hx-trigger="load, fioRefresh from:body" hx-swap="innerHTML">
                {% include 'partials/fio_loading.html' %}
            </div>
        </div>
    </section>

    <section class="discord-export">
        <h2>Share to Discord</h2>
        <p>Edit if needed, then copy:</p>
        <div class="discord-preview-container">
            <textarea id="discord-preview" class="discord-preview" rows="8" placeholder="Loading..."></textarea>
        </div>
        <button class="btn btn-secondary" id="copy-discord-btn" onclick="copyDiscordFormat()">
            Copy to Clipboard
        </button>
    </section>
</div>

<script>
async function loadDiscordPreview() {
    const preview = document.getElementById('discord-preview');
    try {
        const response = await fetch('/u/{{ current_user.fio_username }}/discord');
        preview.value = await response.text();
    } catch (e) {
        preview.value = 'Error loading preview';
    }
}

async function copyDiscordFormat() {
    const preview = document.getElementById('discord-preview');
    const btn = document.getElementById('copy-discord-btn');

    await navigator.clipboard.writeText(preview.value);

    // Show copied feedback
    const originalText = btn.textContent;
    btn.textContent = 'Copied!';
    btn.classList.add('btn-success');

    setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('btn-success');
    }, 2000);
}

// Load discord preview on page load
document.addEventListener('DOMContentLoaded', loadDiscordPreview);

// Show loading overlay on FIO containers during refresh
document.body.addEventListener('htmx:beforeRequest', function(evt) {
    if (evt.detail.pathInfo.requestPath === '/api/fio/refresh') {
        document.querySelectorAll('.fio-data-container').forEach(el => {
            el.classList.add('loading');
        });
    }
});

// Trigger refresh of FIO data sections after manual refresh
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.pathInfo.requestPath === '/api/fio/refresh') {
        htmx.trigger(document.body, 'fioRefresh');
    }
    // Also hide overlay when inventory/suggestions finish loading
    if (evt.detail.pathInfo.requestPath.includes('/api/dashboard/')) {
        document.querySelectorAll('.fio-data-container').forEach(el => {
            el.classList.remove('loading');
        });
        // Update discord preview when inventory changes
        loadDiscordPreview();
    }
});
</script>
{% endblock %}
