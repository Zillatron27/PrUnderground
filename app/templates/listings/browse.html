{% extends "base.html" %}
{% from "macros/responsive.html" import seller_display, material_ticker, quantity_display, status_badge, status_dot, cx_location, price_display, date_display %}

{% block content %}
<div class="browse-page">
    <h1>Browse Listings</h1>

    <div class="browse-tabs">
        <a href="/listings" class="browse-tab active">Items</a>
        <a href="/bundles" class="browse-tab">Bundles</a>
    </div>

    {% if cx_sync_age %}
    <div class="fio-status-bar">
        <span class="fio-refresh-status">CX prices: {{ cx_sync_age }}</span>
    </div>
    {% endif %}

    {# Collapsible filter section #}
    <div class="filter-section">
        <div class="filter-bar">
            <button type="button" class="btn-small" id="filter-toggle">
                <span class="filter-toggle-show">show filters</span>
                <span class="filter-toggle-hide">hide filters</span>
            </button>
            <div class="active-filters" id="active-filters">
                {% if filter_material %}
                    {% for mat in filter_material.split(',') %}
                    <span class="filter-pill" data-type="material" data-value="{{ mat.strip() }}">
                        {{ mat.strip() }}
                        <button type="button" class="filter-pill-remove" aria-label="Remove filter">&times;</button>
                    </span>
                    {% endfor %}
                {% endif %}
                {% if filter_location %}
                <span class="filter-pill" data-type="location" data-value="{{ filter_location }}">
                    @ {{ filter_location }}
                    <button type="button" class="filter-pill-remove" aria-label="Remove filter">&times;</button>
                </span>
                {% endif %}
            </div>
            {% if filter_material or filter_location %}
            <button type="button" class="btn-small" id="filter-clear">clear all</button>
            {% endif %}
        </div>
        <div class="filter-fields" id="filter-fields">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="material">Material</label>
                    <input type="text" id="material" name="material"
                           placeholder="e.g., RAT, DW, FE"
                           list="material-list"
                           autocomplete="off">
                    <datalist id="material-list" hx-get="/listings/api/materials" hx-trigger="load" hx-swap="innerHTML">
                    </datalist>
                    <span class="help-text">Comma-separated for multiple</span>
                </div>
                <div class="filter-group">
                    <label for="location">Location</label>
                    <select id="location" name="location">
                        <option value="">All locations</option>
                        {% for loc in available_locations %}
                        <option value="{{ loc }}" {% if loc == filter_location %}selected{% endif %}>
                            {{ loc }}
                        </option>
                        {% endfor %}
                    </select>
                    <span class="help-text">&nbsp;</span>
                </div>
            </div>
        </div>
    </div>

    {% if listings %}
    {% if sort_spec != [('status', 'asc'), ('updated', 'desc')] %}
    <div class="sort-builder" id="sort-builder">
        <span class="sort-label">Sort:</span>
        <div class="sort-chips" id="sort-chips">
            {% for col, dir in sort_spec %}
            <span class="sort-chip" data-column="{{ col }}" data-direction="{{ dir }}">
                {{ col | capitalize }}
                <span class="sort-chip-dir">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>
                <button type="button" class="sort-chip-remove" aria-label="Remove {{ col }} sort">&times;</button>
            </span>
            {% endfor %}
        </div>
        <button type="button" class="sort-clear" id="sort-clear">Clear</button>
    </div>
    {% endif %}

    <div class="table-wrapper">
    <table class="listings-table" id="listings-table">
        <thead>
            <tr>
                <th class="col-seller">Seller</th>
                <th class="col-material sortable" data-column="material">
                    Material
                    {% for col, dir in sort_spec %}{% if col == 'material' %}<span class="sort-indicator">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}{% endfor %}
                </th>
                <th class="col-status sortable" data-column="status">
                    Status
                    {% for col, dir in sort_spec %}{% if col == 'status' %}<span class="sort-indicator">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}{% endfor %}
                </th>
                <th class="col-quantity sortable" data-column="quantity">
                    Qty
                    {% for col, dir in sort_spec %}{% if col == 'quantity' %}<span class="sort-indicator">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}{% endfor %}
                </th>
                <th class="col-price sortable" data-column="price">
                    Price
                    {% for col, dir in sort_spec %}{% if col == 'price' %}<span class="sort-indicator">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}{% endfor %}
                </th>
                <th class="col-location sortable" data-column="location">
                    Location
                    {% for col, dir in sort_spec %}{% if col == 'location' %}<span class="sort-indicator">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}{% endfor %}
                </th>
                <th class="col-notes">Notes</th>
                <th class="col-updated sortable" data-column="updated">
                    Updated
                    {% for col, dir in sort_spec %}{% if col == 'updated' %}<span class="sort-indicator">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}{% endfor %}
                </th>
            </tr>
        </thead>
        <tbody>
            {% for listing in listings %}
            <tr>
                <td class="col-seller">{{ seller_display(listing.user) }}</td>
                <td class="col-material">{{ material_ticker(listing.material_ticker, material_categories.get(listing.material_ticker)) }}</td>
                <td class="col-status">
                    <span class="status-wide">{{ status_badge(listing) }}</span>
                    <span class="status-medium">{{ status_dot(listing) }}</span>
                </td>
                <td class="col-quantity qty-cell"{% if listing.available_quantity is not none and is_sync_stale(listing.user) %} title="FIO data updated > 1 day ago"{% endif %}>
                    {{ quantity_display(listing) }}
                </td>
                <td class="col-price">{{ price_display(listing, cx_prices) }}</td>
                <td class="col-location">{{ cx_location(listing.storage_name or listing.location) }}</td>
                <td class="col-notes notes-cell" {% if listing.notes %}title="{{ listing.notes }}"{% endif %}>{{ listing.notes or '—' }}</td>
                <td class="col-updated">{{ date_display(listing.updated_at) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>No listings found{% if filter_material or filter_location %} matching your filters{% endif %}.</p>
    </div>
    {% endif %}
</div>

<script>
(function() {
    // ========================================
    // Filter Section
    // ========================================
    const filterToggle = document.getElementById('filter-toggle');
    const filterFields = document.getElementById('filter-fields');
    const filterClear = document.getElementById('filter-clear');
    const materialInput = document.getElementById('material');
    const locationSelect = document.getElementById('location');

    // Navigate with current filter values
    function applyFilters() {
        const url = new URL(window.location.href);
        const material = materialInput ? materialInput.value.trim() : '';
        const location = locationSelect ? locationSelect.value : '';

        if (material) {
            url.searchParams.set('material', material);
        } else {
            url.searchParams.delete('material');
        }

        if (location) {
            url.searchParams.set('location', location);
        } else {
            url.searchParams.delete('location');
        }

        window.location.href = url.toString();
    }

    // Toggle filter visibility
    if (filterToggle && filterFields) {
        const filterSection = document.querySelector('.filter-section');
        filterToggle.addEventListener('click', () => {
            filterFields.classList.toggle('expanded');
            if (filterSection) {
                filterSection.classList.toggle('filters-expanded', filterFields.classList.contains('expanded'));
            }
        });
        // Initialize state
        if (filterSection && filterFields.classList.contains('expanded')) {
            filterSection.classList.add('filters-expanded');
        }
    }

    // Apply material filter on Enter or Tab (only if input has value)
    if (materialInput) {
        materialInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === 'Tab') {
                const hasValue = materialInput.value.trim() !== '';
                if (hasValue) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                    }
                    applyFilters();
                }
            }
        });
    }

    if (locationSelect) {
        locationSelect.addEventListener('change', applyFilters);
    }

    // Clear all filters
    if (filterClear) {
        filterClear.addEventListener('click', () => {
            const url = new URL(window.location.href);
            url.searchParams.delete('material');
            url.searchParams.delete('location');
            window.location.href = url.toString();
        });
    }

    // Remove individual filter pills
    document.querySelectorAll('.filter-pill-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const pill = btn.closest('.filter-pill');
            const type = pill.dataset.type;
            const value = pill.dataset.value;
            const url = new URL(window.location.href);

            if (type === 'material') {
                const currentMaterial = url.searchParams.get('material') || '';
                const materials = currentMaterial.split(',').map(m => m.trim()).filter(m => m !== value);
                if (materials.length > 0) {
                    url.searchParams.set('material', materials.join(','));
                } else {
                    url.searchParams.delete('material');
                }
            } else if (type === 'location') {
                url.searchParams.delete('location');
            }

            window.location.href = url.toString();
        });
    });

    // ========================================
    // Sort Section
    // ========================================
    let currentSort = {{ sort_spec | tojson }};

    const DEFAULT_SORT = 'status:asc,updated:desc';

    function navigateWithSort(sortArray) {
        const url = new URL(window.location.href);
        const sortParam = sortArray.map(([col, dir]) => `${col}:${dir}`).join(',');

        // Handle default sort — don't include in URL
        if (sortParam === DEFAULT_SORT || sortArray.length === 0) {
            url.searchParams.delete('sort');
        } else {
            url.searchParams.set('sort', sortParam);
        }

        window.location.href = url.toString();
    }

    // Click on column header: add to sort chain, or toggle if already in chain
    document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', (e) => {
            const column = th.dataset.column;
            const existingIdx = currentSort.findIndex(([col]) => col === column);

            let newSort;
            if (existingIdx !== -1) {
                // Column already in sort - toggle direction
                const [, currentDir] = currentSort[existingIdx];
                const newDir = currentDir === 'asc' ? 'desc' : 'asc';
                newSort = currentSort.map(([col, dir], idx) =>
                    idx === existingIdx ? [col, newDir] : [col, dir]
                );
            } else {
                // New column - add to end of sort chain
                newSort = [...currentSort, [column, 'asc']];
            }

            navigateWithSort(newSort);
        });
    });

    // Click on chip direction: toggle asc/desc
    document.querySelectorAll('.sort-chip').forEach(chip => {
        chip.addEventListener('click', (e) => {
            // Don't trigger if clicking the remove button
            if (e.target.classList.contains('sort-chip-remove')) return;

            const column = chip.dataset.column;
            const currentDir = chip.dataset.direction;
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';

            const newSort = currentSort.map(([col, dir]) =>
                col === column ? [col, newDir] : [col, dir]
            );

            navigateWithSort(newSort);
        });
    });

    // Click on chip remove button: remove from sort
    document.querySelectorAll('.sort-chip-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const chip = btn.closest('.sort-chip');
            const column = chip.dataset.column;

            const newSort = currentSort.filter(([col]) => col !== column);

            // If removing all sorts, default back to updated:desc
            if (newSort.length === 0) {
                navigateWithSort([['status', 'asc'], ['updated', 'desc']]);
            } else {
                navigateWithSort(newSort);
            }
        });
    });

    // Clear all sorts
    const sortClearBtn = document.getElementById('sort-clear');
    if (sortClearBtn) {
        sortClearBtn.addEventListener('click', () => {
            navigateWithSort([['status', 'asc'], ['updated', 'desc']]);
        });
    }
})();
</script>
{% endblock %}
