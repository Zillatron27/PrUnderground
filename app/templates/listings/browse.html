{% extends "base.html" %}
{% from "macros/responsive.html" import seller_display, material_ticker, quantity_display, cx_location, price_display %}

{% block content %}
<div class="browse-page">
    <h1>Browse Listings</h1>

    <div class="browse-tabs">
        <a href="/listings" class="browse-tab active">Items</a>
        <a href="/bundles" class="browse-tab">Bundles</a>
    </div>

    <form class="filter-form" method="get" action="/listings">
        <div class="filter-row">
            <div class="filter-group">
                <label for="material">Material</label>
                <input type="text" id="material" name="material"
                       value="{{ filter_material }}"
                       placeholder="e.g., RAT, DW, FE"
                       list="material-list"
                       autocomplete="off">
                <datalist id="material-list" hx-get="/listings/api/materials" hx-trigger="load" hx-swap="innerHTML">
                </datalist>
                <span class="help-text">Comma-separated for multiple</span>
            </div>
            <div class="filter-group">
                <label for="location">Location</label>
                <select id="location" name="location">
                    <option value="">All locations</option>
                    {% for loc in available_locations %}
                    <option value="{{ loc }}" {% if loc == filter_location %}selected{% endif %}>
                        {{ loc }}
                    </option>
                    {% endfor %}
                </select>
                <span class="help-text">&nbsp;</span>
            </div>
            <div class="filter-group filter-actions-group">
                <label>&nbsp;</label>
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">Search</button>
                    {% if filter_material or filter_location %}
                    <a href="/listings" class="btn btn-secondary">Clear</a>
                    {% endif %}
                </div>
                <span class="help-text">&nbsp;</span>
            </div>
        </div>
    </form>

    {% if listings %}
    <div class="sort-builder" id="sort-builder">
        <span class="sort-label">Sort:</span>
        <div class="sort-chips" id="sort-chips">
            {% for col, dir in sort_spec %}
            <span class="sort-chip" data-column="{{ col }}" data-direction="{{ dir }}">
                {{ col | capitalize }}
                <span class="sort-chip-dir">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>
                <button type="button" class="sort-chip-remove" aria-label="Remove {{ col }} sort">&times;</button>
            </span>
            {% endfor %}
        </div>
        {% if sort_spec != [('updated', 'desc')] %}
        <button type="button" class="sort-clear" id="sort-clear">Clear</button>
        {% endif %}
    </div>

    <div class="table-wrapper">
    <table class="listings-table" id="listings-table">
        <thead>
            <tr>
                <th class="col-seller">Seller</th>
                <th class="col-material sortable" data-column="material">
                    Material
                    {% for col, dir in sort_spec %}{% if col == 'material' %}<span class="sort-indicator">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}{% endfor %}
                </th>
                <th class="col-quantity sortable" data-column="quantity">
                    Qty
                    {% for col, dir in sort_spec %}{% if col == 'quantity' %}<span class="sort-indicator">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}{% endfor %}
                </th>
                <th class="col-price sortable" data-column="price">
                    Price
                    {% for col, dir in sort_spec %}{% if col == 'price' %}<span class="sort-indicator">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}{% endfor %}
                </th>
                <th class="col-location sortable" data-column="location">
                    Location
                    {% for col, dir in sort_spec %}{% if col == 'location' %}<span class="sort-indicator">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}{% endfor %}
                </th>
                <th class="col-notes">Notes</th>
                <th class="col-updated sortable" data-column="updated">
                    Updated
                    {% for col, dir in sort_spec %}{% if col == 'updated' %}<span class="sort-indicator">{% if dir == 'asc' %}▲{% else %}▼{% endif %}</span>{% endif %}{% endfor %}
                </th>
            </tr>
        </thead>
        <tbody>
            {% for listing in listings %}
            <tr>
                <td class="col-seller">{{ seller_display(listing.user) }}</td>
                <td class="col-material">{{ material_ticker(listing.material_ticker) }}</td>
                <td class="col-quantity qty-cell"{% if listing.available_quantity is not none and is_sync_stale(listing.user) %} title="FIO data updated > 1 day ago"{% endif %}>
                    {{ quantity_display(listing) }}
                </td>
                <td class="col-price">{{ price_display(listing) }}</td>
                <td class="col-location">{{ cx_location(listing.storage_name or listing.location) }}</td>
                <td class="col-notes notes-cell" {% if listing.notes %}title="{{ listing.notes }}"{% endif %}>{{ listing.notes or '—' }}</td>
                <td class="col-updated">{{ listing.updated_at.strftime('%Y-%m-%d') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>No listings found{% if filter_material or filter_location %} matching your filters{% endif %}.</p>
    </div>
    {% endif %}
</div>

<script>
(function() {
    // Parse current sort state from template data
    let currentSort = {{ sort_spec | tojson }};

    function navigateWithSort(sortArray) {
        const url = new URL(window.location.href);
        const sortParam = sortArray.map(([col, dir]) => `${col}:${dir}`).join(',');

        // Handle default sort (updated:desc) - don't include in URL
        if (sortParam === 'updated:desc' || sortArray.length === 0) {
            url.searchParams.delete('sort');
        } else {
            url.searchParams.set('sort', sortParam);
        }

        window.location.href = url.toString();
    }

    // Click on column header: add to sort chain, or toggle if already in chain
    document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', (e) => {
            const column = th.dataset.column;
            const existingIdx = currentSort.findIndex(([col]) => col === column);

            let newSort;
            if (existingIdx !== -1) {
                // Column already in sort - toggle direction
                const [, currentDir] = currentSort[existingIdx];
                const newDir = currentDir === 'asc' ? 'desc' : 'asc';
                newSort = currentSort.map(([col, dir], idx) =>
                    idx === existingIdx ? [col, newDir] : [col, dir]
                );
            } else {
                // New column - add to end of sort chain
                newSort = [...currentSort, [column, 'asc']];
            }

            navigateWithSort(newSort);
        });
    });

    // Click on chip direction: toggle asc/desc
    document.querySelectorAll('.sort-chip').forEach(chip => {
        chip.addEventListener('click', (e) => {
            // Don't trigger if clicking the remove button
            if (e.target.classList.contains('sort-chip-remove')) return;

            const column = chip.dataset.column;
            const currentDir = chip.dataset.direction;
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';

            const newSort = currentSort.map(([col, dir]) =>
                col === column ? [col, newDir] : [col, dir]
            );

            navigateWithSort(newSort);
        });
    });

    // Click on chip remove button: remove from sort
    document.querySelectorAll('.sort-chip-remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const chip = btn.closest('.sort-chip');
            const column = chip.dataset.column;

            const newSort = currentSort.filter(([col]) => col !== column);

            // If removing all sorts, default back to updated:desc
            if (newSort.length === 0) {
                navigateWithSort([['updated', 'desc']]);
            } else {
                navigateWithSort(newSort);
            }
        });
    });

    // Clear all sorts
    const clearBtn = document.getElementById('sort-clear');
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            navigateWithSort([['updated', 'desc']]);
        });
    }
})();
</script>
{% endblock %}
