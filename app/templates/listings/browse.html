{% extends "base.html" %}

{% block content %}
<div class="browse-page">
    <h1>Browse Listings</h1>

    <form class="filter-form" method="get" action="/listings">
        <div class="filter-row">
            <div class="filter-group">
                <label for="material">Material</label>
                <input type="text" id="material" name="material"
                       value="{{ filter_material }}"
                       placeholder="e.g., RAT, DW, FE"
                       list="material-list"
                       autocomplete="off">
                <datalist id="material-list" hx-get="/listings/api/materials" hx-trigger="load" hx-swap="innerHTML">
                </datalist>
                <span class="help-text">Comma-separated for multiple</span>
            </div>
            <div class="filter-group">
                <label for="location">Location</label>
                <select id="location" name="location">
                    <option value="">All locations</option>
                    {% for loc in available_locations %}
                    <option value="{{ loc }}" {% if loc == filter_location %}selected{% endif %}>
                        {{ loc }}
                    </option>
                    {% endfor %}
                </select>
                <span class="help-text">&nbsp;</span>
            </div>
            <div class="filter-group filter-actions-group">
                <label>&nbsp;</label>
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">Search</button>
                    {% if filter_material or filter_location %}
                    <a href="/listings" class="btn btn-secondary">Clear</a>
                    {% endif %}
                </div>
                <span class="help-text">&nbsp;</span>
            </div>
        </div>
    </form>

    {% if listings %}
    <div class="table-wrapper">
    <table class="listings-table">
        <thead>
            <tr>
                <th>Seller</th>
                <th>Material</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Location</th>
                <th>Notes</th>
                <th>Updated</th>
            </tr>
        </thead>
        <tbody>
            {% for listing in listings %}
            <tr>
                <td>
                    <a href="/u/{{ listing.user.fio_username }}">
                        {% if listing.user.company_code %}[{{ listing.user.company_code }}]{% endif %}
                        {{ listing.user.fio_username }}
                    </a>
                </td>
                <td><strong>{{ listing.material_ticker }}</strong></td>
                <td class="qty-cell">
                    {% if listing.available_quantity is not none %}
                        {{ '{:,}'.format(listing.available_quantity) }}
                    {% elif listing.quantity %}
                        {{ '{:,}'.format(listing.quantity) }}
                    {% else %}
                        —
                    {% endif %}
                    {% if get_stock_status(listing) == 'out' %}
                        <span class="badge badge-out-of-stock">OUT OF STOCK</span>
                    {% elif get_stock_status(listing) == 'low' %}
                        <span class="badge badge-low-stock">LOW STOCK</span>
                    {% endif %}
                </td>
                <td>{{ format_price(listing) }}</td>
                <td>{{ listing.storage_name or listing.location or '—' }}</td>
                <td class="notes-cell" {% if listing.notes %}title="{{ listing.notes }}"{% endif %}>{{ listing.notes or '—' }}</td>
                <td>{{ listing.updated_at.strftime('%Y-%m-%d') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    {% else %}
    <div class="empty-state">
        <p>No listings found{% if filter_material or filter_location %} matching your filters{% endif %}.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
