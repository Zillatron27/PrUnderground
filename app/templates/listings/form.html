{% extends "base.html" %}

{% block content %}
<div class="form-page">
    <h1>{% if listing %}Edit{% else %}Create{% endif %} Listing</h1>

    <form method="post" action="{% if listing %}/listings/{{ listing.id }}/edit{% else %}/listings/new{% endif %}" class="listing-form">
        <input type="hidden" name="{{ csrf_field_name }}" value="{{ csrf_token }}">
        <div class="form-group">
            <label for="material_ticker">Material Ticker</label>
            <input type="text" id="material_ticker" name="material_ticker"
                   value="{{ listing.material_ticker if listing else request.query_params.get('material', '') }}"
                   required maxlength="10" placeholder="e.g., RAT, DW, OVE"
                   list="material-suggestions">
            <datalist id="material-suggestions" hx-get="/listings/api/suggestions" hx-trigger="load" hx-swap="innerHTML">
            </datalist>
        </div>

        <div class="form-group">
            <label for="quantity">Quantity (optional)</label>
            <input type="number" id="quantity" name="quantity" min="0"
                   value="{{ listing.quantity if listing and listing.quantity else '' }}"
                   placeholder="Leave empty for standing offer">
        </div>

        <div class="form-group">
            <label>Pricing</label>
            <div class="price-options">
                <label class="radio-option">
                    <input type="radio" name="price_type" value="absolute"
                           {% if not listing or listing.price_type.value == 'absolute' %}checked{% endif %}
                           onchange="togglePriceFields()">
                    <span>Fixed Price</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="price_type" value="cx_relative"
                           {% if listing and listing.price_type.value == 'cx_relative' %}checked{% endif %}
                           onchange="togglePriceFields()">
                    <span>CX Relative</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="price_type" value="contact_me"
                           {% if listing and listing.price_type.value == 'contact_me' %}checked{% endif %}
                           onchange="togglePriceFields()">
                    <span>Contact Me</span>
                </label>
            </div>
        </div>

        <div class="form-row price-fields" id="price-absolute-fields">
            <div class="form-group">
                <label for="price_value_absolute">Price per Unit</label>
                <input type="number" id="price_value_absolute" name="price_value_absolute" step="0.01"
                       value="{{ listing.price_value if listing and listing.price_type.value == 'absolute' and listing.price_value else '' }}"
                       placeholder="e.g., 160">
            </div>
        </div>

        <div class="form-row price-fields" id="price-cx-fields" style="display:none">
            <div class="form-group">
                <label for="price_value_cx">CX Offset (%)</label>
                <input type="number" id="price_value_cx" name="price_value_cx" step="1"
                       value="{{ listing.price_value if listing and listing.price_type.value == 'cx_relative' and listing.price_value else '' }}"
                       placeholder="e.g., -10 for 10% below CX">
            </div>
            <div class="form-group">
                <label for="price_exchange">Exchange</label>
                <select id="price_exchange" name="price_exchange">
                    <option value="">Any</option>
                    <option value="NC1" {% if listing and listing.price_exchange == 'NC1' %}selected{% endif %}>NC1 (Moria)</option>
                    <option value="NC2" {% if listing and listing.price_exchange == 'NC2' %}selected{% endif %}>NC2 (Benten)</option>
                    <option value="IC1" {% if listing and listing.price_exchange == 'IC1' %}selected{% endif %}>IC1 (Hortus)</option>
                    <option value="CI1" {% if listing and listing.price_exchange == 'CI1' %}selected{% endif %}>CI1 (Arclight)</option>
                    <option value="AI1" {% if listing and listing.price_exchange == 'AI1' %}selected{% endif %}>AI1 (Antares)</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="listing_type">Listing Type</label>
                <select id="listing_type" name="listing_type" onchange="toggleExpiryField()">
                    <option value="standing" {% if not listing or listing.listing_type.value == 'standing' %}selected{% endif %}>
                        Standing Offer
                    </option>
                    <option value="special" {% if listing and listing.listing_type.value == 'special' %}selected{% endif %}>
                        Special/Deal
                    </option>
                </select>
            </div>
            <div class="form-group" id="expiry-field" style="display:none">
                <label for="expires_at">Expires (optional)</label>
                <input type="date" id="expires_at" name="expires_at"
                       value="{{ listing.expires_at.strftime('%Y-%m-%d') if listing and listing.expires_at else '' }}">
                <p class="help-text">Leave empty for no expiry</p>
            </div>
        </div>

        <div class="form-group">
            <label>Location & Inventory</label>
            <p class="help-text">Select a storage for live inventory tracking, or type a custom location</p>
        </div>
        <div class="form-row">
            <div class="form-group fio-data-container" id="storage-container">
                <div class="fio-data-overlay fio-data-overlay-inline">
                    <div class="spinner-data spinner-sm"></div>
                    <span>Loading storages...</span>
                </div>
                <label for="storage_id">Inventory</label>
                <select id="storage_id" name="storage_id" onchange="updateLocationFromStorage()"
                        hx-get="/listings/api/storages{% if listing and listing.storage_id %}?selected={{ listing.storage_id }}{% endif %}"
                        hx-trigger="load"
                        hx-swap="innerHTML">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div class="form-group" id="custom-location-group">
                <label for="location">Pickup Location</label>
                <input type="text" id="location" name="location" maxlength="50"
                       value="{{ listing.location if listing else '' }}"
                       placeholder="e.g., Moria Station"
                       list="location-options">
                <datalist id="location-options" hx-get="/listings/api/locations" hx-trigger="load" hx-swap="innerHTML">
                </datalist>
                <p class="help-text price-preview">Start typing to search</p>
            </div>
        </div>
        <div class="form-row" id="reserve-row" style="display:none">
            <div class="form-group">
                <label for="reserve_quantity">Reserve (keep in stock)</label>
                <input type="number" id="reserve_quantity" name="reserve_quantity" min="0"
                       value="{{ listing.reserve_quantity if listing and listing.reserve_quantity else '0' }}"
                       placeholder="0">
                <p class="help-text">Amount to keep - won't be shown as available</p>
            </div>
        </div>
        <input type="hidden" id="storage_name" name="storage_name"
               value="{{ listing.storage_name if listing else '' }}">

        <div class="form-group">
            <label for="notes">Notes (optional)</label>
            <textarea id="notes" name="notes" rows="3"
                      placeholder="Any additional info (bulk discounts, availability, etc.)">{{ listing.notes if listing else '' }}</textarea>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                {% if listing %}Update{% else %}Create{% endif %} Listing
            </button>
            <a href="/dashboard" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
function togglePriceFields() {
    const priceType = document.querySelector('input[name="price_type"]:checked').value;
    document.getElementById('price-absolute-fields').style.display =
        priceType === 'absolute' ? 'flex' : 'none';
    document.getElementById('price-cx-fields').style.display =
        priceType === 'cx_relative' ? 'flex' : 'none';
}

function toggleExpiryField() {
    const listingType = document.getElementById('listing_type').value;
    document.getElementById('expiry-field').style.display =
        listingType === 'special' ? 'block' : 'none';
}

function updateLocationFromStorage() {
    const select = document.getElementById('storage_id');
    const hidden = document.getElementById('storage_name');
    const locationInput = document.getElementById('location');
    const customLocationGroup = document.getElementById('custom-location-group');
    const reserveRow = document.getElementById('reserve-row');

    if (!select) return;

    const option = select.options[select.selectedIndex];
    const hasStorage = select.value !== '';

    // Update hidden storage_name
    if (hidden) {
        hidden.value = option.dataset.name || '';
    }

    // Show/hide custom location field
    if (customLocationGroup) {
        customLocationGroup.style.display = hasStorage ? 'none' : 'block';
    }

    // Auto-fill location from storage name when selecting storage
    if (hasStorage && locationInput) {
        locationInput.value = option.dataset.name || '';
    }

    // Show/hide reserve field
    if (reserveRow) {
        reserveRow.style.display = hasStorage ? 'flex' : 'none';
    }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
    togglePriceFields();
    toggleExpiryField();
});

// Show loading state for storage select
document.body.addEventListener('htmx:beforeRequest', function(evt) {
    if (evt.detail.pathInfo.requestPath.includes('/api/storages')) {
        const container = document.getElementById('storage-container');
        if (container) container.classList.add('loading');
    }
});

// After storages load, update UI and hide overlay
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.pathInfo.requestPath.includes('/api/storages')) {
        const container = document.getElementById('storage-container');
        if (container) container.classList.remove('loading');
        updateLocationFromStorage();
    }
});
</script>
{% endblock %}
