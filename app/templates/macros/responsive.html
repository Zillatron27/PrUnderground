{#
    Responsive display macros for PrUnderground
    These macros provide both full and condensed versions of common display elements.
    CSS controls which version is visible based on screen size.
#}

{# CX station abbreviations #}
{% set CX_ABBREV = {
    'Antares Station': 'ANT',
    'Moria Station': 'MOR',
    'Benten Station': 'BEN',
    'Hortus Station': 'HRT',
    'Arclight Station': 'ARC'
} %}

{#
    Material ticker display
    Always bold, monospace, cyan - same at all sizes
#}
{% macro material_ticker(ticker) -%}
<span class="ticker">{{ ticker }}</span>
{%- endmacro %}

{#
    Seller display with optional corp code
    Desktop: [CORP] Username
    Medium/Narrow: Username only
#}
{% macro seller_display(user) -%}
<a href="/u/{{ user.fio_username }}">
    {%- if user.company_code %}<span class="hide-medium">[{{ user.company_code }}] </span>{% endif -%}
    {{ user.fio_username }}
</a>
{%- endmacro %}

{#
    CX location display
    Desktop: Full name (Moria Station)
    Medium/Narrow: Abbreviation (MOR)
#}
{% macro cx_location(location) -%}
{%- if location -%}
    <span class="hide-medium">{{ location }}</span>
    <span class="show-medium">{{ CX_ABBREV.get(location, location) }}</span>
{%- else -%}
    —
{%- endif -%}
{%- endmacro %}

{#
    Price display
    Desktop: Full formatted price (CX.NC1-10%, 1,500/u)
    Medium/Narrow: Condensed (CX-10%, 1.5k/u)
    If cx_prices is available, shows calculated actual price for CX-relative listings
#}
{% macro price_display(listing, cx_prices=None) -%}
{%- set calculated_price = None -%}
{%- if cx_prices and listing.price_type.value == 'cx_relative' and listing.price_value is not none and listing.price_exchange and listing.material_ticker -%}
    {%- set cx_key = (listing.material_ticker, listing.price_exchange) -%}
    {%- set cx_ask = cx_prices.get(cx_key) -%}
    {%- if cx_ask -%}
        {%- set calculated_price = calculate_cx_actual_price(cx_ask, listing.price_value, listing.price_cx_is_absolute) -%}
    {%- endif -%}
{%- endif -%}
<span class="hide-medium">{{ format_price(listing) }}{% if calculated_price %} <span class="cx-calculated">({{ '{:,.0f}'.format(calculated_price) }}/u)</span>{% endif %}</span>
<span class="show-medium">
    {%- if listing.price_type.value == 'absolute' and listing.price_value is not none -%}
        {{ condense_number(listing.price_value) }}/u
    {%- elif listing.price_type.value == 'cx_relative' and listing.price_value is not none -%}
        {%- if calculated_price -%}
            {{ condense_number(calculated_price) }}/u
        {%- else -%}
            CX{{ '{:+.0f}'.format(listing.price_value) }}{% if not listing.price_cx_is_absolute %}%{% endif %}
        {%- endif -%}
    {%- else -%}
        —
    {%- endif -%}
</span>
{%- endmacro %}

{#
    Quantity display with stock status
    Desktop: Number + text badge (OUT OF STOCK, LOW STOCK)
    Medium/Narrow: Number + color dot indicator
#}
{% macro quantity_display(listing) -%}
{%- set qty = listing.available_quantity if listing.available_quantity is not none else listing.quantity -%}
{%- set status = get_stock_status(listing) -%}
{%- set qty_class = 'qty-out' if status == 'out' else ('qty-low' if status == 'low' else 'qty-ok') -%}
<span class="qty-value {{ qty_class }}">
    {%- if qty is not none -%}
        {{ '{:,}'.format(qty) }}
    {%- else -%}
        —
    {%- endif -%}
</span>
{%- if status == 'out' -%}
    <span class="badge badge-out-of-stock hide-medium">OUT OF STOCK</span>
    <span class="stock-dot stock-out show-medium" title="Out of stock"></span>
{%- elif status == 'low' -%}
    <span class="badge badge-low-stock hide-medium">LOW STOCK</span>
    <span class="stock-dot stock-low show-medium" title="Low stock"></span>
{%- endif -%}
{%- endmacro %}

{#
    Bundle price display
    Desktop: Full formatted price
    Medium/Narrow: Condensed
#}
{% macro bundle_price_display(bundle) -%}
{%- if bundle.price -%}
    <span class="hide-medium">{{ '{:,.0f}'.format(bundle.price) }} {{ bundle.currency or '' }}</span>
    <span class="show-medium">{{ condense_number(bundle.price) }}{{ ' ' + bundle.currency if bundle.currency else '' }}</span>
{%- else -%}
    Contact me
{%- endif -%}
{%- endmacro %}

{#
    Bundle quantity display
    Handles different stock modes:
    - MANUAL: quantity or "—"
    - UNLIMITED: ∞ (cyan)
    - MADE_TO_ORDER: Purple badge + optional "(X ready)"
    - FIO_SYNC: computed quantity + stock badges
    Uses get_bundle_stock_status() for threshold-aware stock badges.
#}
{% macro bundle_quantity_display(bundle) -%}
{%- set status = get_bundle_stock_status(bundle) -%}
{%- if bundle.stock_mode.value == 'unlimited' -%}
    <span class="qty-unlimited">∞</span>
{%- elif bundle.stock_mode.value == 'made_to_order' -%}
    <span class="badge badge-made-to-order">Made to Order</span>
    {%- if bundle.ready_quantity -%}
        <span class="qty-ready">({{ bundle.ready_quantity }} ready)</span>
    {%- endif -%}
{%- elif bundle.stock_mode.value == 'fio_sync' -%}
    {%- set qty = bundle.available_quantity -%}
    {%- if qty is not none -%}
        <span class="hide-medium">{{ '{:,}'.format(qty) }}</span>
        <span class="show-medium">{{ condense_number(qty) }}</span>
        {%- if status == 'out' -%}
            <span class="badge badge-out-of-stock hide-medium">OUT OF STOCK</span>
            <span class="stock-dot stock-out show-medium" title="Out of stock"></span>
        {%- elif status == 'low' -%}
            <span class="badge badge-low-stock hide-medium">LOW STOCK</span>
            <span class="stock-dot stock-low show-medium" title="Low stock"></span>
        {%- endif -%}
    {%- else -%}
        —
    {%- endif -%}
{%- else -%}
    {# MANUAL mode (default) #}
    {%- if bundle.quantity is not none -%}
        <span class="hide-medium">{{ '{:,}'.format(bundle.quantity) }}</span>
        <span class="show-medium">{{ condense_number(bundle.quantity) }}</span>
        {%- if status == 'out' -%}
            <span class="badge badge-out-of-stock hide-medium">OUT OF STOCK</span>
            <span class="stock-dot stock-out show-medium" title="Out of stock"></span>
        {%- elif status == 'low' -%}
            <span class="badge badge-low-stock hide-medium">LOW STOCK</span>
            <span class="stock-dot stock-low show-medium" title="Low stock"></span>
        {%- endif -%}
    {%- else -%}
        —
    {%- endif -%}
{%- endif -%}
{%- endmacro %}

{#
    Date display
    Desktop: DD-MM-YYYY
    Medium/Narrow: DD Mon (e.g., 26 Jan)
#}
{% macro date_display(dt) -%}
<span class="hide-medium">{{ dt.strftime('%d-%m-%Y') }}</span>
<span class="show-medium">{{ dt.strftime('%d %b') }}</span>
{%- endmacro %}

{#
    Dashboard quantity display (for live inventory)
    Desktop: Full number with comma formatting
    Medium/Narrow: Condensed (184.6k)
#}
{% macro dashboard_qty(value) -%}
{%- if value is not none -%}
<span class="hide-medium">{{ '{:,}'.format(value) }}</span>
<span class="show-medium">{{ condense_number(value) }}</span>
{%- else -%}
—
{%- endif -%}
{%- endmacro %}
