{#
    Responsive display macros for PrUnderground
    These macros provide both full and condensed versions of common display elements.
    CSS controls which version is visible based on screen size.
#}

{# CX station abbreviations #}
{% set CX_ABBREV = {
    'Antares Station': 'ANT',
    'Moria Station': 'MOR',
    'Benten Station': 'BEN',
    'Hortus Station': 'HRT',
    'Arclight Station': 'ARC'
} %}

{#
    Material ticker display with category colors
    Renders as a clickable tile linking to browse filtered by material
    category: Material category name (e.g., "Agricultural Products")
    link: If true, render as clickable <a> element
#}
{% macro material_ticker(ticker, category=None, link=True) -%}
{%- set cat_slug = (category|lower|replace(' ', '-')|replace('(', '')|replace(')', '')) if category else 'default' -%}
{%- if link -%}
<a href="/listings?material={{ ticker }}" class="mat-tile mat-tile-{{ cat_slug }}">{{ ticker }}</a>
{%- else -%}
<span class="mat-tile mat-tile-{{ cat_slug }}">{{ ticker }}</span>
{%- endif -%}
{%- endmacro %}

{#
    Seller display with optional corp code
    Desktop: [CORP] Username
    Medium/Narrow: Username only
#}
{% macro seller_display(user) -%}
<a href="/u/{{ user.fio_username }}">
    {%- if user.company_code %}<span class="hide-medium">[{{ user.company_code }}] </span>{% endif -%}
    {{ user.fio_username }}
</a>
{%- endmacro %}

{#
    CX location display
    Desktop: Full name (Moria Station)
    Medium/Narrow: Abbreviation (MOR)
#}
{% macro cx_location(location) -%}
{%- if location -%}
    <span class="hide-medium">{{ location }}</span>
    <span class="show-medium">{{ CX_ABBREV.get(location, location) }}</span>
{%- else -%}
    —
{%- endif -%}
{%- endmacro %}

{#
    Price display
    Desktop: Full formatted price (CX.NC1-10%, 1,500/u)
    Medium/Narrow: Condensed (CX-10%, 1.5k/u)
    If cx_prices is available, shows calculated actual price for CX-relative listings
#}
{% macro price_display(listing, cx_prices=None) -%}
{%- set calculated_price = None -%}
{%- if cx_prices and listing.price_type.value == 'cx_relative' and listing.price_value is not none and listing.price_exchange and listing.material_ticker -%}
    {%- set cx_key = (listing.material_ticker, listing.price_exchange) -%}
    {%- set cx_ask = cx_prices.get(cx_key) -%}
    {%- if cx_ask -%}
        {%- set calculated_price = calculate_cx_actual_price(cx_ask, listing.price_value, listing.price_cx_is_absolute) -%}
    {%- endif -%}
{%- endif -%}
<span class="hide-medium">{{ format_price(listing) }}{% if calculated_price %} <span class="cx-calculated">({{ '{:,.0f}'.format(calculated_price) }}/u)</span>{% endif %}</span>
<span class="show-medium">
    {%- if listing.price_type.value == 'absolute' and listing.price_value is not none -%}
        {{ condense_number(listing.price_value) }}/u
    {%- elif listing.price_type.value == 'cx_relative' and listing.price_value is not none -%}
        {%- if calculated_price -%}
            {{ condense_number(calculated_price) }}/u
        {%- else -%}
            CX{{ '{:+.0f}'.format(listing.price_value) }}{% if not listing.price_cx_is_absolute %}%{% endif %}
        {%- endif -%}
    {%- else -%}
        —
    {%- endif -%}
</span>
{%- endmacro %}

{#
    Status badge for dedicated STATUS column (wide view, 720px+)
    Shows full text badge: IN STOCK, LOW, OUT
    Note: Individual material listings don't have stock_mode (unlimited/MTO are bundle-only)
#}
{% macro status_badge(listing) -%}
{%- set status = get_stock_status(listing) -%}
{%- if status == 'out' -%}
    <span class="status-badge out" title="Out of stock">OUT</span>
{%- elif status == 'low' -%}
    <span class="status-badge low" title="Low stock">LOW</span>
{%- else -%}
    <span class="status-badge instock" title="In stock">IN STOCK</span>
{%- endif -%}
{%- endmacro %}

{#
    Status dot for medium view (450-720px)
    Shows colored dot indicator only
#}
{% macro status_dot(listing) -%}
{%- set status = get_stock_status(listing) -%}
{%- if status == 'out' -%}
    <span class="status-dot out" title="Out of stock"></span>
{%- elif status == 'low' -%}
    <span class="status-dot low" title="Low stock"></span>
{%- else -%}
    <span class="status-dot instock" title="In stock"></span>
{%- endif -%}
{%- endmacro %}

{#
    Quantity display with stock status
    Wide/Medium: Neutral color (badge/dot handles status)
    Narrow (<450px): Colored text (column hidden)
#}
{% macro quantity_display(listing) -%}
{%- set qty = listing.available_quantity if listing.available_quantity is not none else listing.quantity -%}
{%- set status = get_stock_status(listing) -%}
{%- set qty_class_narrow = 'qty-out' if status == 'out' else ('qty-low' if status == 'low' else 'qty-ok') -%}
<span class="qty-value qty-neutral hide-narrow">
    {%- if qty is not none -%}{{ '{:,}'.format(qty) }}{%- else -%}—{%- endif -%}
</span>
<span class="qty-value {{ qty_class_narrow }} show-narrow">
    {%- if qty is not none -%}{{ '{:,}'.format(qty) }}{%- else -%}—{%- endif -%}
</span>
{%- endmacro %}

{#
    Bundle price display
    Desktop: Full formatted price
    Medium/Narrow: Condensed
#}
{% macro bundle_price_display(bundle) -%}
{%- if bundle.price -%}
    <span class="hide-medium">{{ '{:,.0f}'.format(bundle.price) }} {{ bundle.currency or '' }}</span>
    <span class="show-medium">{{ condense_number(bundle.price) }}{{ ' ' + bundle.currency if bundle.currency else '' }}</span>
{%- else -%}
    Contact me
{%- endif -%}
{%- endmacro %}

{#
    Bundle status badge for STATUS column (wide view, 720px+)
    Handles stock_mode variants:
    - unlimited → "∞" badge (cyan)
    - made_to_order → "MTO" badge (purple)
    - fio_sync/manual with qty=0 → "OUT" badge (red)
    - fio_sync/manual with low qty → "LOW" badge (orange)
    - fio_sync/manual with normal qty → "IN STOCK" badge (green)
#}
{% macro bundle_status_badge(bundle) -%}
{%- set status = get_bundle_stock_status(bundle) -%}
{%- if bundle.stock_mode.value == 'unlimited' -%}
    <span class="status-badge unlimited" title="Unlimited availability">∞</span>
{%- elif bundle.stock_mode.value == 'made_to_order' -%}
    <span class="status-badge mto" title="Made to Order">MTO</span>
{%- elif status == 'out' -%}
    <span class="status-badge out" title="Out of stock">OUT</span>
{%- elif status == 'low' -%}
    <span class="status-badge low" title="Low stock">LOW</span>
{%- else -%}
    <span class="status-badge instock" title="In stock">IN STOCK</span>
{%- endif -%}
{%- endmacro %}

{#
    Bundle status dot for medium view (450-720px)
    Same colors as badge, compact display
#}
{% macro bundle_status_dot(bundle) -%}
{%- set status = get_bundle_stock_status(bundle) -%}
{%- if bundle.stock_mode.value == 'unlimited' -%}
    <span class="status-dot unlimited" title="Unlimited availability"></span>
{%- elif bundle.stock_mode.value == 'made_to_order' -%}
    <span class="status-dot mto" title="Made to Order"></span>
{%- elif status == 'out' -%}
    <span class="status-dot out" title="Out of stock"></span>
{%- elif status == 'low' -%}
    <span class="status-dot low" title="Low stock"></span>
{%- else -%}
    <span class="status-dot instock" title="In stock"></span>
{%- endif -%}
{%- endmacro %}

{#
    Bundle quantity display
    Handles different stock modes:
    - MANUAL: quantity or "—"
    - UNLIMITED: ∞ (cyan) for narrow view, neutral for wide/medium
    - MADE_TO_ORDER: "(X ready)" with tooltip for narrow view, neutral for wide/medium
    - FIO_SYNC: computed quantity

    Wide/Medium: Neutral color (STATUS column handles status display)
    Narrow (<450px): Colored text (STATUS column hidden)
#}
{% macro bundle_quantity_display(bundle) -%}
{%- set status = get_bundle_stock_status(bundle) -%}
{%- if bundle.stock_mode.value == 'unlimited' -%}
    {# Wide/Medium: neutral ∞, Narrow: colored ∞ #}
    <span class="qty-value qty-neutral hide-narrow">∞</span>
    <span class="qty-value qty-unlimited show-narrow">∞</span>
{%- elif bundle.stock_mode.value == 'made_to_order' -%}
    {# Show (X) or (X ready) with tooltip #}
    {%- if bundle.ready_quantity -%}
        <span class="qty-value qty-neutral hide-narrow" title="{{ bundle.ready_quantity }} units ready to ship">({{ bundle.ready_quantity }})</span>
        <span class="qty-value qty-mto show-narrow" title="{{ bundle.ready_quantity }} units ready to ship">({{ bundle.ready_quantity }})</span>
    {%- else -%}
        <span class="qty-value qty-neutral hide-narrow" title="Made to order - contact seller">—</span>
        <span class="qty-value qty-mto show-narrow" title="Made to order - contact seller">—</span>
    {%- endif -%}
{%- elif bundle.stock_mode.value == 'fio_sync' -%}
    {%- set qty = bundle.available_quantity -%}
    {%- if qty is not none -%}
        {%- set qty_class_narrow = 'qty-out' if status == 'out' else ('qty-low' if status == 'low' else 'qty-ok') -%}
        <span class="qty-value qty-neutral hide-narrow">
            <span class="hide-medium">{{ '{:,}'.format(qty) }}</span>
            <span class="show-medium">{{ condense_number(qty) }}</span>
        </span>
        <span class="qty-value {{ qty_class_narrow }} show-narrow">{{ condense_number(qty) }}</span>
    {%- else -%}
        —
    {%- endif -%}
{%- else -%}
    {# MANUAL mode (default) #}
    {%- if bundle.quantity is not none -%}
        {%- set qty_class_narrow = 'qty-out' if status == 'out' else ('qty-low' if status == 'low' else 'qty-ok') -%}
        <span class="qty-value qty-neutral hide-narrow">
            <span class="hide-medium">{{ '{:,}'.format(bundle.quantity) }}</span>
            <span class="show-medium">{{ condense_number(bundle.quantity) }}</span>
        </span>
        <span class="qty-value {{ qty_class_narrow }} show-narrow">{{ condense_number(bundle.quantity) }}</span>
    {%- else -%}
        —
    {%- endif -%}
{%- endif -%}
{%- endmacro %}

{#
    Date display
    Desktop: DD-MM-YYYY
    Medium/Narrow: DD Mon (e.g., 26 Jan)
#}
{% macro date_display(dt) -%}
<span class="hide-medium">{{ dt.strftime('%d-%m-%Y') }}</span>
<span class="show-medium">{{ dt.strftime('%d %b') }}</span>
{%- endmacro %}

{#
    Dashboard quantity display (for live inventory)
    Desktop: Full number with comma formatting
    Medium/Narrow: Condensed (184.6k)
#}
{% macro dashboard_qty(value) -%}
{%- if value is not none -%}
<span class="hide-medium">{{ '{:,}'.format(value) }}</span>
<span class="show-medium">{{ condense_number(value) }}</span>
{%- else -%}
—
{%- endif -%}
{%- endmacro %}
