{% from "macros/responsive.html" import material_ticker, price_display, cx_location, date_display, dashboard_qty %}
{% for listing in listings %}
{% set is_expired = listing.expires_at and listing.expires_at < now %}
<tr class="{% if is_expired %}listing-expired{% endif %}" data-listing-id="{{ listing.id }}">
    <td class="col-material">{{ material_ticker(listing.material_ticker) }}</td>
    <td class="col-quantity">
        {% if listing.id in listing_inventory %}
            {% set inv = listing_inventory[listing.id] %}
            {% set qty_class = 'qty-ok' %}
            {% set stock_badge = '' %}
            {% set stock_status = '' %}
            {% if inv.available == 0 %}
                {% set qty_class = 'qty-out' %}
                {% set stock_badge = 'OUT OF STOCK' %}
                {% set stock_status = 'out' %}
            {% elif inv.available <= 10 %}
                {% set qty_class = 'qty-low' %}
                {% set stock_badge = 'LOW STOCK' %}
                {% set stock_status = 'low' %}
            {% endif %}
            <span class="live-inventory {{ qty_class }}" title="{{ inv.actual }} in stock - {{ inv.reserve }} reserved">
                {{ dashboard_qty(inv.available) }}
                <small class="inventory-detail hide-medium">({{ inv.actual }} - {{ inv.reserve }})</small>
            </span>
            {% if stock_badge %}
                <span class="badge badge-{% if inv.available == 0 %}out-of-stock{% else %}low-stock{% endif %} hide-medium">{{ stock_badge }}</span>
                <span class="stock-dot stock-{{ stock_status }} show-medium" title="{{ stock_badge }}"></span>
            {% endif %}
        {% elif listing.quantity %}
            {{ listing.quantity }}
        {% else %}
            —
        {% endif %}
    </td>
    <td class="col-price">{{ price_display(listing) }}</td>
    <td class="col-location">{{ cx_location(listing.storage_name or listing.location) }}</td>
    <td class="col-type">
        <span class="badge badge-{{ listing.listing_type.value }}">
            {{ listing.listing_type.value }}
        </span>
        {% if listing.expires_at %}
            {% if is_expired %}
            <span class="badge badge-expired">Expired</span>
            {% else %}
            <span class="expiry-info hide-medium">
                expires {{ listing.expires_at.strftime('%d %b') }}
            </span>
            {% endif %}
        {% endif %}
    </td>
    <td class="col-notes notes-cell" {% if listing.notes %}title="{{ listing.notes }}"{% endif %}>
        {{ listing.notes or '—' }}
    </td>
    <td class="col-updated">{{ date_display(listing.updated_at) }}</td>
    <td class="col-actions actions">
        <a href="/listings/{{ listing.id }}/edit" class="btn btn-sm">Edit</a>
        <form action="/listings/{{ listing.id }}/delete" method="post" style="display:inline">
            <input type="hidden" name="{{ csrf_field_name }}" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-sm btn-danger"
                    onclick="return confirm('Delete this listing?')">Delete</button>
        </form>
    </td>
</tr>
{% endfor %}
