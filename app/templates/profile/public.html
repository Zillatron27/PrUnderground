{% extends "base.html" %}

{% block content %}
<div class="profile-page">
    <header class="profile-header">
        <div>
            <h1>
                {% if profile_user.company_code %}[{{ profile_user.company_code }}]{% endif %}
                {{ profile_user.fio_username }}
            </h1>
            {% if profile_user.company_name %}
            <p class="company-name">{{ profile_user.company_name }}</p>
            {% endif %}
            <p class="member-since">Member since {{ profile_user.created_at.strftime('%B %Y') }}</p>
        </div>
        <div class="profile-actions">
            <button class="btn btn-secondary" id="copy-discord-btn" onclick="copyDiscordFormat()">
                Copy for Discord
            </button>
            {% if current_user and current_user.id == profile_user.id %}
            <a href="/dashboard" class="btn btn-primary">Edit Listings</a>
            {% endif %}
        </div>
    </header>

    <section class="profile-listings">
        <h2>Listings ({{ listings|length }})</h2>
        {% if profile_user.fio_last_synced or listings %}
        <p class="fio-status-bar">
            {% if profile_user.fio_last_synced %}
            <span class="fio-refresh-status">FIO data updated: {{ get_sync_staleness(profile_user) }}</span>
            {% endif %}
            {% if profile_user.fio_last_synced and listings %} · {% endif %}
            {% if listings %}
            <span class="fio-refresh-status">Listings updated: {{ listings[0].updated_at.strftime('%d %b %Y') }}</span>
            {% endif %}
        </p>
        {% endif %}
        {% if listings %}
        <div class="table-wrapper">
        <table class="listings-table">
            <thead>
                <tr>
                    <th>Material</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Location</th>
                    <th>Type</th>
                    <th>Notes</th>
                    <th>Updated</th>
                </tr>
            </thead>
            <tbody>
                {% for listing in listings %}
                <tr>
                    <td><strong>{{ listing.material_ticker }}</strong></td>
                    <td class="qty-cell">
                        {% if listing.available_quantity is not none %}
                            {{ '{:,}'.format(listing.available_quantity) }}
                        {% elif listing.quantity %}
                            {{ '{:,}'.format(listing.quantity) }}
                        {% else %}
                            —
                        {% endif %}
                        {% if get_stock_status(listing) == 'out' %}
                            <span class="badge badge-out-of-stock">OUT OF STOCK</span>
                        {% elif get_stock_status(listing) == 'low' %}
                            <span class="badge badge-low-stock">LOW STOCK</span>
                        {% endif %}
                    </td>
                    <td>{{ format_price(listing) }}</td>
                    <td>{{ listing.storage_name or listing.location or '—' }}</td>
                    <td>
                        <span class="badge badge-{{ listing.listing_type.value }}">
                            {{ listing.listing_type.value }}
                        </span>
                    </td>
                    <td class="notes-cell" {% if listing.notes %}title="{{ listing.notes }}"{% endif %}>{{ listing.notes or '—' }}</td>
                    <td>{{ listing.updated_at.strftime('%Y-%m-%d') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p>This user hasn't created any listings yet.</p>
        </div>
        {% endif %}
    </section>
</div>

<script>
async function copyDiscordFormat() {
    const response = await fetch('/u/{{ profile_user.fio_username }}/discord');
    const text = await response.text();
    await navigator.clipboard.writeText(text);

    const btn = document.getElementById('copy-discord-btn');
    const originalText = btn.textContent;
    btn.textContent = 'Copied!';
    btn.classList.add('btn-success');

    setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('btn-success');
    }, 2000);
}
</script>
{% endblock %}
