{% extends "base.html" %}
{% from "macros/responsive.html" import material_ticker, quantity_display, status_badge, status_dot, price_display, cx_location, bundle_price_display, bundle_quantity_display, bundle_status_badge, bundle_status_dot, date_display %}

{% block content %}
<div class="profile-page">
    <header class="profile-header">
        <div>
            <h1>
                {% if profile_user.company_code %}[{{ profile_user.company_code }}]{% endif %}
                {{ profile_user.fio_username }}
            </h1>
            {% if profile_user.company_name %}
            <p class="company-name">{{ profile_user.company_name }}</p>
            {% endif %}
            <p class="member-since">Member since {{ profile_user.created_at.strftime('%B %Y') }}</p>
        </div>
        <div class="profile-actions">
            {% if current_user and current_user.id == profile_user.id %}
            <button class="btn btn-secondary" id="copy-discord-btn" onclick="copyDiscordFormat()">
                Copy for Discord
            </button>
            <a href="/dashboard" class="btn btn-primary">Edit Listings</a>
            {% endif %}
        </div>
    </header>

    {% if cx_sync_age %}
    <div class="fio-status-bar">
        <span class="fio-refresh-status">CX prices: {{ cx_sync_age }}</span>
    </div>
    {% endif %}

    <section class="profile-listings">
        <h2>Listings ({{ listings|length }})</h2>
        {% if listings %}
        <div class="table-wrapper">
        <table class="listings-table">
            <thead>
                <tr>
                    <th class="col-material">Material</th>
                    <th class="col-status">Status</th>
                    <th class="col-quantity">Qty</th>
                    <th class="col-price">Price</th>
                    <th class="col-location">Location</th>
                    <th class="col-type">Type</th>
                    <th class="col-notes">Notes</th>
                    <th class="col-updated">Updated</th>
                </tr>
            </thead>
            <tbody>
                {% for listing in listings %}
                <tr>
                    <td class="col-material">{{ material_ticker(listing.material_ticker, material_categories.get(listing.material_ticker)) }}</td>
                    <td class="col-status">
                        <span class="status-wide">{{ status_badge(listing) }}</span>
                        <span class="status-medium">{{ status_dot(listing) }}</span>
                    </td>
                    <td class="col-quantity qty-cell">{{ quantity_display(listing) }}</td>
                    <td class="col-price">{{ price_display(listing, cx_prices) }}</td>
                    <td class="col-location">{{ cx_location(listing.storage_name or listing.location) }}</td>
                    <td class="col-type">
                        <span class="badge badge-{{ listing.listing_type.value }}">
                            {{ listing.listing_type.value }}
                        </span>
                    </td>
                    <td class="col-notes notes-cell" {% if listing.notes %}title="{{ listing.notes }}"{% endif %}>{{ listing.notes or 'â€”' }}</td>
                    <td class="col-updated">{{ date_display(listing.updated_at) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p>This user hasn't created any listings yet.</p>
        </div>
        {% endif %}
    </section>

    {% if bundles %}
    <section class="profile-bundles">
        <h2>Bundles ({{ bundles|length }})</h2>
        <div class="table-wrapper">
        <table class="listings-table">
            <thead>
                <tr>
                    <th class="col-name">Name</th>
                    <th class="col-status">Status</th>
                    <th class="col-items">Items</th>
                    <th class="col-quantity">Qty</th>
                    <th class="col-price">Price</th>
                    <th class="col-location">Location</th>
                    <th class="col-updated">Updated</th>
                    <th class="col-actions">&nbsp;</th>
                </tr>
            </thead>
            <tbody>
                {% for bundle in bundles %}
                <tr>
                    <td class="col-name" title="{{ bundle.name }}"><strong>{{ bundle.name }}</strong></td>
                    <td class="col-status">
                        <span class="status-wide">{{ bundle_status_badge(bundle) }}</span>
                        <span class="status-medium">{{ bundle_status_dot(bundle) }}</span>
                    </td>
                    <td class="col-items">{{ bundle.items|length }}</td>
                    <td class="col-quantity">{{ bundle_quantity_display(bundle) }}</td>
                    <td class="col-price">{{ bundle_price_display(bundle) }}</td>
                    <td class="col-location">{{ cx_location(bundle.location) }}</td>
                    <td class="col-updated">{{ date_display(bundle.updated_at) }}</td>
                    <td class="col-actions">
                        <button class="btn btn-sm btn-secondary"
                                hx-get="/bundles/{{ bundle.id }}/detail"
                                hx-target="#modal-container"
                                hx-swap="innerHTML">
                            View
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </section>
    {% endif %}
</div>

<div id="modal-container"></div>

<script>
async function copyDiscordFormat() {
    const response = await fetch('/u/{{ profile_user.fio_username }}/discord');
    const text = await response.text();
    await navigator.clipboard.writeText(text);

    const btn = document.getElementById('copy-discord-btn');
    const originalText = btn.textContent;
    btn.textContent = 'Copied!';
    btn.classList.add('btn-success');

    setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('btn-success');
    }, 2000);
}

function closeModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('modal-container').innerHTML = '';
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});
</script>
{% endblock %}
